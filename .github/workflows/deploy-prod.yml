name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  AWS_REGION: us-east-1

jobs:
  deploy-backend:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update kubeconfig
        run: |
          echo "Checking if EKS cluster exists..."
          if aws eks describe-cluster --name globepay-prod-eks --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "Production cluster found, updating kubeconfig..."
            if aws eks update-kubeconfig --name globepay-prod-eks --region ${{ env.AWS_REGION }}; then
              echo "Kubeconfig updated successfully"
              # Test connectivity to the cluster
              echo "Testing cluster connectivity..."
              if kubectl cluster-info >/dev/null 2>&1; then
                echo "Cluster connectivity test passed"
              else
                echo "WARNING: Cluster connectivity test failed, but continuing with deployment..."
              fi
            else
              echo "Failed to update kubeconfig, but continuing with deployment..."
            fi
          else
            echo "Production cluster globepay-prod-eks not found, skipping kubeconfig update"
          fi
      
      - name: Create backup before deployment
        run: |
          # Trigger database backup
          echo "Creating database snapshot before deployment..."
          if aws rds create-db-snapshot \
            --db-instance-identifier globepay-prod-db \
            --db-snapshot-identifier pre-deploy-$(date +%Y%m%d-%H%M%S); then
            echo "Database snapshot created successfully"
          else
            echo "Backup creation failed, continuing with deployment..."
          fi
      
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
      
      - name: Prepare for Helm deployment
        run: |
          # Delete existing resources that might conflict with Helm
          echo "Deleting existing secrets that might conflict with Helm..."
          kubectl delete secret backend-secrets -n globepay-prod --ignore-not-found
          kubectl delete secret postgresql-secrets -n globepay-prod --ignore-not-found
          
          # Set the image tag to the commit SHA with 'sha-' prefix
          BACKEND_TAG="sha-${GITHUB_SHA:0:7}"
          FRONTEND_TAG="sha-${GITHUB_SHA:0:7}"
          
          echo "Deploying with Helm using backend tag: $BACKEND_TAG and frontend tag: $FRONTEND_TAG"
          
          # Update the production values file with the new image tags
          sed -i "s/tag: latest/tag: $BACKEND_TAG/g" helm/globepay/values-prod.yaml
          sed -i "s/tag: latest/tag: $FRONTEND_TAG/g" helm/globepay/values-prod.yaml
      
      - name: Deploy with Helm
        run: |
          # Deploy using Helm
          helm upgrade --install globepay-prod ./helm/globepay \
            -f ./helm/globepay/values-prod.yaml \
            --namespace globepay-prod \
            --create-namespace \
            --set secrets.dbPassword="${{ secrets.DB_PASSWORD }}" \
            --set secrets.jwtSecret="${{ secrets.JWT_SECRET }}" \
            --timeout 10m \
            --wait
      
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/globepay-prod-backend -n globepay-prod --timeout=20m
          kubectl rollout status deployment/globepay-prod-frontend -n globepay-prod --timeout=20m
      
      - name: Run production smoke tests
        run: |
          SERVICE_URL="${{ secrets.PROD_API_URL }}"
          
          if [ -z "$SERVICE_URL" ]; then
            echo "PROD_API_URL not set, skipping smoke tests"
            exit 0
          fi
          
          echo "Running health check against $SERVICE_URL..."
          if curl -f ${SERVICE_URL}/health --max-time 30; then
            echo "Health check passed"
          else
            echo "Health check failed"
            exit 1
          fi
          
          echo "Running metrics check..."
          if curl -f ${SERVICE_URL}/metrics --max-time 30; then
            echo "Metrics check passed"
          else
            echo "Metrics check failed"
            exit 1
          fi
      
      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Production Backend Deployment (Helm): ${{ job.status }}
            Environment: Production
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
          channel: ${{ secrets.SLACK_CHANNEL }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-frontend:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update kubeconfig
        run: |
          echo "Checking if EKS cluster exists..."
          if aws eks describe-cluster --name globepay-prod-eks --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "Production cluster found, updating kubeconfig..."
            if aws eks update-kubeconfig --name globepay-prod-eks --region ${{ env.AWS_REGION }}; then
              echo "Kubeconfig updated successfully"
              # Test connectivity to the cluster
              echo "Testing cluster connectivity..."
              if kubectl cluster-info >/dev/null 2>&1; then
                echo "Cluster connectivity test passed"
              else
                echo "WARNING: Cluster connectivity test failed, but continuing with deployment..."
              fi
            else
              echo "Failed to update kubeconfig, but continuing with deployment..."
            fi
          else
            echo "Production cluster globepay-prod-eks not found, skipping kubeconfig update"
          fi
      
      - name: Deploy to S3 and CloudFront
        run: |
          echo "Building frontend application..."
          cd frontend
          if npm ci && npm run build; then
            echo "Frontend build completed successfully"
          else
            echo "Frontend build failed, exiting..."
            exit 1
          fi
          
          echo "Deploying to S3..."
          if aws s3 sync dist/ s3://globepay-prod-assets/ --delete; then
            echo "S3 deployment completed successfully"
          else
            echo "S3 deployment failed, exiting..."
            exit 1
          fi
          
          echo "Creating CloudFront invalidation..."
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            if aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"; then
              echo "CloudFront invalidation created successfully"
            else
              echo "CloudFront invalidation failed, continuing..."
            fi
          else
            echo "CLOUDFRONT_DISTRIBUTION_ID not set, skipping invalidation"
          fi
      
      - name: Verify frontend accessibility
        run: |
          FRONTEND_URL="${{ secrets.PROD_FRONTEND_URL }}"
          
          if [ -z "$FRONTEND_URL" ]; then
            echo "PROD_FRONTEND_URL not set, skipping frontend accessibility check"
            exit 0
          fi
          
          echo "Verifying frontend accessibility at $FRONTEND_URL..."
          if curl -f ${FRONTEND_URL} --max-time 30; then
            echo "Frontend is accessible"
          else
            echo "Frontend is not accessible"
            exit 1
          fi
      
      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Production Frontend Deployment (Helm): ${{ job.status }}
            Environment: Production
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
          channel: ${{ secrets.SLACK_CHANNEL }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}